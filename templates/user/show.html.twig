{% extends 'base.html.twig' %}

{% block title %}User{% endblock %}

{% block body %}
    <h1>{{ user.username }}</h1>
    
    {% if app.user %}
    <a class="btn btn-primary" href="{{ path('user_chat', {'id': user.id}) }}">Ver chats</a>
    {% endif %}

    {# ==================================
       BOT√ìN SEGUIR / SOLICITUD AMISTAD
       ================================== #}
    {% if app.user and app.user.id != user.id %}

        {# ¬øya le sigo? (usamos lo que ya ten√≠as) #}
        {% set isFollowing = (user in app.user.following) %}

        {% if user.isPrivate %}
            {# PERFIL PRIVADO #}

            {# ¬øya he enviado una solicitud pendiente? #}
            {% set pending = false %}
            {% for req in app.user.sentFriendRequests %}
                {% if req.receiver and req.receiver.id == user.id and req.status == 'PENDING' %}
                    {% set pending = true %}
                {% endif %}
            {% endfor %}

            {% if pending %}
                <p>Solicitud enviada</p>

            {% elseif isFollowing %}
                <a href="{{ path('app_user_unfollow', {'id': user.id}) }}">Dejar de seguir</a>

            {% else %}
                <a href="{{ path('app_friend_request_send', {'id': user.id}) }}">Enviar solicitud</a>
            {% endif %}

        {% else %}
            {# PERFIL P√öBLICO: igual que antes #}
            {% if isFollowing %}
                <a href="{{ path('app_user_unfollow', {'id': user.id}) }}">Dejar de seguir</a>
            {% else %}
                <a href="{{ path('app_user_follow', {'id': user.id}) }}">Seguir</a>
            {% endif %}
        {% endif %}
    {% endif %}

    <h2>Followers ({{ user.followers|length }})</h2>
    <ul>
        {% for follower in user.followers %}
            <li>
                <a href="{{ path('app_user_show', {'username': follower.username}) }}">{{ follower.username }}</a>
            </li>
        {% else %}
            <li>No followers</li>
        {% endfor %}
    </ul>

    <h2>Following ({{ user.following|length }})</h2>
    <ul>
        {% for followed in user.following %}
            <li>
                <a href="{{ path('app_user_show', {'username': followed.username}) }}">{{ followed.username }}</a>
            </li>
        {% else %}
            <li>Not following anyone</li>
        {% endfor %}
    </ul>

    {# QUI√âN PUEDE VER LOS POSTS #}
{% set canSeePosts = (not user.isPrivate) %}

{% if user.isPrivate %}
    {% if app.user and (app.user.id == user.id or app.user in user.followers) %}
        {% set canSeePosts = true %}
    {% endif %}
{% endif %}

<h2>Posts ({{ user.posts|length }})</h2>

{% if canSeePosts %}
    <ul>
        {% for post in user.posts %}
            <li>
                <a href="{{ path('app_post_show', {'id': post.id}) }}">
                    {{ post.text ? post.text|length > 30 ? post.text|slice(0, 30) ~ '...' : post.text : 'Image only' }}
                </a>
            </li>
        {% else %}
            <li>No posts yet</li>
        {% endfor %}
    </ul>
{% else %}
    <p>Esta cuenta es privada. Solo los seguidores pueden ver sus posts.</p>
{% endif %}

{# SOLICITUDES RECIBIDAS (solo si tu cuenta es privada) #}
{% if app.user and app.user.id == user.id and user.isPrivate %}
    <h2>Solicitudes de amistad pendientes</h2>
    <ul>
        {% set hasPending = false %}

        {% for req in user.receivedFriendRequests %}
            {% if req.status == 'PENDING' %}
                {% set hasPending = true %}
                <li>
                    <a href="{{ path('app_user_show', {'username': req.sender.username}) }}">
                        {{ req.sender.username }}
                    </a>
                    -
                    <a href="{{ path('app_friend_request_accept', {'id': req.id}) }}">Aceptar</a>
                    <a href="{{ path('app_friend_request_reject', {'id': req.id}) }}">Rechazar</a>
                </li>
            {% endif %}
        {% endfor %}

        {% if not hasPending %}
            <li>No tienes solicitudes pendientes</li>
        {% endif %}
    </ul>
{% endif %}

    {# NUEVA SECCI√ìN: Reposts del usuario #}
    <h2>Reposts ({{ user.reposts|length }})</h2>
    <ul>
        {% for repost in user.reposts %}
            <li>
                üîÅ <a href="{{ path('app_post_show', {'id': repost.id}) }}">
                    {% if repost.text %}
                        {{ repost.text|length > 30 ? repost.text|slice(0, 30) ~ '...' : repost.text }}
                    {% else %}
                        Image only
                    {% endif %}
                </a>
                (Original by <a href="{{ path('app_user_show', {'username': repost.author.username}) }}">
                    {{ repost.author.username }}
                </a>)
            </li>
        {% else %}
            <li>No reposts yet</li>
        {% endfor %}
    </ul>

    <a href="{{ path('app_post_index') }}">Back to list</a>

    {# Solo el usuario mismo puede editar su perfil #}
    {% if app.user and app.user.id == user.id %}
        <a href="{{ path('app_user_edit', {'id': user.id}) }}">Edit</a>
        {{ include('user/_delete_form.html.twig') }}
    {% endif %}

    {# Admin puede eliminar cualquier usuario #}
    {% if is_granted('ROLE_ADMIN') and app.user.id != user.id %}
        {{ include('user/_delete_form.html.twig') }}
    {% endif %}

{% endblock %}
